<script type="text/javascript">
  window.fbAsyncInit = function() {
    FB.init({
      appId  : <%= ENV['FB_APP_ID'] %>,
      status : true, // check login status
      cookie : true, // enable cookies to allow the server to access the session
      xfbml  : true  // parse XFBML
    });

    console.log('Facebook is fully loaded now...')

    FB.Event.subscribe('auth.statusChange', function(response) {
      console.log('The status of the session is: ' + response.status);
      console.log('auth Response: ' + $.param({ signed_request: response.authResponse.signedRequest }) );
          if (response.authResponse) {
      	    $.getJSON('users/auth/facebook/callback', { signed_request: response.authResponse.signedRequest }, function(json) {
      	      $('#connect').html('Connected! Callback complete.');
      	      $('#results').html(JSON.stringify(json));
      	      localStorage.setItem('friends', JSON.stringify(json['friends']));
      	      localStorage.setItem('uid', JSON.stringify(json['uid']));
      	    });// getJSON ends
      	  };
    });
  };

  (function(d) {
    var js, id = 'facebook-jssdk'; if (d.getElementById(id)) {return;}
    js = d.createElement('script'); js.id = id; js.async = true;
    js.src = window.location.protocol + "//connect.facebook.net/en_US/all.js";
    d.getElementsByTagName('head')[0].appendChild(js);
  }(document));

  $(function() {
    $('#connect .signin').click(function(e) {
      e.preventDefault();
      FB.getLoginStatus(function(response) {
        if (response.status === 'connected') {
          console.log('Logged in.');
          $.getJSON('users/auth/facebook/callback', { signed_request: response.authResponse.signedRequest }, function(json) {
            $('#connect').html('Connected! Callback complete.');
            $('#results').html(JSON.stringify(json));
            localStorage.setItem('friends', JSON.stringify(json['friends']));
            localStorage.setItem('uid', JSON.stringify(json['uid']));
          });// getJSON ends
        }
        else {
          FB.login(function(response) {
            console.log(response);
            if (response.authResponse) {
              //$('#connect').html('Connected! Hitting OmniAuth callback (GET users/auth/facebook/callback)...');

              // since we have cookies enabled, this request will allow omniauth to parse
              // out the auth code from the signed request in the fbsr_XXX cookie
              $.getJSON('users/auth/facebook/callback', { signed_request: response.authResponse.signedRequest }, function(json) {
                $('#connect').html('Connected! Callback complete.');
                $('#results').html(JSON.stringify(json));
                localStorage.setItem('friends', JSON.stringify(json['friends']));
                localStorage.setItem('uid', JSON.stringify(json['uid']));
              });// getJSON ends
            }
          });
        }
      });

    });

    $('#connect .signout').click(function(e) {
      e.preventDefault();
      $.getJSON('/auth/facebook/signout', function(json) {
        $('#connect').html('Connected! Callback complete.');
        $('#results').html(JSON.stringify(json));
      });
    });

  });
</script>
